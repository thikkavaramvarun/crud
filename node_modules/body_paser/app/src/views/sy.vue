<template>
  <div>
    <van-search 
    v-model="value" 
    show-action placeholder="请输入搜索关键词" @search="onSearch">
      <template #action>
        <div @click="onSearch">搜索</div>
      </template>
    </van-search>
    <van-tabs v-model="active" @change="change">
      <van-tab :title="item.text" v-for="(item, index) in list" :key="index"></van-tab>
    </van-tabs>
    <van-pull-refresh v-model="refreshing" @refresh="onRefresh">
      <van-list v-model="loading" :finished="finished" finished-text="没有更多了" @load="onLoad">
        <div v-for="(item, index) in shoplist" :key="index">
          <van-swipe-cell>
            <shoplist :obj="item" @info="info(item.id)"></shoplist>
            <template #right>
              <van-button square text="删除" type="danger" class="delete-button" @click="del(index)" />
            </template>
          </van-swipe-cell>
        </div>
      </van-list>
    </van-pull-refresh>
  </div>
</template>

<script>
import shoplist from "@/components/shoplist.vue";
import axios from "axios";
import { Toast } from "vant";
export default {
  components: {
    shoplist
  },
  data() {
    return {
      value: "",
      active: 0,
      list: [],
      shoplist: [],
      loading: false,
      finished: false,
      refreshing: false,
      index: 0
    };
  },
  created() {
    this.init();
  },
  methods: {
    init() {
      axios({
        url: "/shop/list",
        method: "get"
      }).then(res => {
        this.list = res.data.data;
        this.shoplist = this.list[this.active].children.slice(0, 10);
      });
    },
    onSearch() {
      this.shoplist = this.list[this.active].children.filter(item =>
        item.title.includes(this.value)
      );
      this.value = "";
    },
    change(e) {
      this.shoplist = this.list[e].children.slice(0, 10);
    },
    onLoad() {
      setTimeout(() => {
        if (this.refreshing) {
          this.shoplist = [];
          this.refreshing = false;
        }
        this.index++;
        this.shoplist.push(
          ...this.list[this.active].children.slice(
            (this.index * 10, this.index * 10 + 10)
          )
        );
        this.loading = false;

        if (this.shoplist.length >= this.list[this.active].children.length) {
          this.finished = true;
        }
      }, 1000);
    },
    onRefresh() {
      this.finished = false;
      this.loading = true;
      this.onLoad();
    },
    info(id) {
      this.$router.push({ name: "info", params: { id: id } });
    },
    del(index) {
      this.shoplist.splice(index, 1);
      Toast("删除成功");
    }
  }
};
</script>

<style scoped>
.delete-button {
  height: 100%;
}
</style>