<template>
  <div>
    <van-form @submit="onSubmit" ref="sub">
        <van-field
            v-model="obj.username"
            name="用户名"
            label="用户名"
            placeholder="用户名"
            :rules="[{ required: true, message: '请填写用户名' }]"
        />
        <van-field
            v-model="obj.password"
            type="password"
            name="password"
            label="密码"
            placeholder="请填写密码"
            :rules="[{ required: true, message: '密码需为8位数字' }]"
        />
        <van-field
            v-model="obj.passwords"
            type="password"
            name="passwords"
            label="二次密码"
            placeholder="请在次输入密码"
            :rules="[{ validator: vsadpassword, message: '二次密码不一致' }]"
        />
        <van-field
            v-model="obj.phone"
            name="phone"
            label="手机号"
            placeholder="请在次输入手机号"
            :rules="[{ required: true, message: '号码格式错误' }]"
        >
        <template #label>
            <select>
                <option value="86">+86</option>
                <option value="87">+87</option>
            </select>
        </template>
        </van-field>
        <van-field
            v-model="obj.sms"
            center
            clearable
            label="验证码"
            placeholder="请输入验证码"
            :rules="[{ validator: vscodeSms, message: '验证码错误' }]"
            >
            <template #button>
                <van-button size="small" type="primary" v-if="showSms" @click="send">发送验证码</van-button>
                <van-button size="small" type="primary" v-else disabled>{{ time }}秒回重试</van-button>
            </template>
        </van-field>
        <div class="flex-zhao">
            上传证件执照：<van-uploader v-model="fileList" multiple />
        </div>
        <div style="margin: 16px;">
            <van-button round block type="info" native-type="submit" v-if="showSub" :disabled="jinyon">登录</van-button>
            <van-button round block loading type="info" loading-text="加载中..." disabled v-else></van-button>
        </div>
    </van-form>
  </div>
</template>

<script>
import axios from 'axios'
export default {
    props:{
        obj:{
            type:Object,
            default(){
                return{}
            }
        }
    },
  data() {
    return {
        showSub:true,
        jinyon:true,
        showSms:true,
        time:10,
        fileList: [
        { url: 'https://img01.yzcdn.cn/vant/ipad.jpeg',isImage: true},
      ],
    };
  },
  mounted(){
        this.time=localStorage.getItem('time');
        this.showSms=JSON.parse(localStorage.getItem('showSms'))
        if(!this.showSms){
            const timer = setInterval(()=>{
                this.time--
                if(this.time<0){
                    this.time=10;
                    this.showSms=true
                    clearInterval(timer);
                }
                localStorage.setItem('time',this.time)
                localStorage.setItem('showSms',JSON.stringify(this.showSms))
              
            },1000)
        }
    },
   watch:{
        obj:{
            handler:function(){
                this.$refs.sub.validate().then(()=>{
                    this.jinyon=false
                }).catch(()=>{
                  
                })
            },
            deep:true
        }
   },
  methods: {
    onSubmit() {
        this.showSub=false
        const timer=setTimeout(()=>{
            axios({
                url:'/login',
                method:'post'
            }).then(res=>{
                localStorage.setItem('token',res.data.data)
                this.$router.push('/')
            })
            setTimeout(timer)
        },2000)
    },
    send(){
        this.showSms=false
        const code = Math.random().toString().substring(3,9)
        this.$toast(code)
        localStorage.setItem('sms',code)
        const timer=setInterval(()=>{
          this.time--;
          
            if(this.time<=0){
                this.time=10;
                this.showSms=true
                clearInterval(timer)
            }
            localStorage.setItem('time',this.time)
            localStorage.setItem('showSms',JSON.stringify(this.showSms))
        },1000)
    },
    vscodeSms(val){
        return val==localStorage.getItem('sms')
    },
    vsadpassword(val){
        return val==this.obj.password
    }
  },
};
</script>

<style scoped lang="scss">
.flex-zhao{
    display: flex;
    align-items: center;
}
</style>